<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DLPT Violation Ledger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8 min-h-screen">
  <div class="container mx-auto max-w-7xl bg-white rounded-xl shadow-lg overflow-hidden relative">
    <header class="bg-gray-800 text-white p-6 flex flex-col sm:flex-row justify-between items-center rounded-t-xl">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight mb-4 sm:mb-0">Violation Ledger</h1>
      <!-- Responsive Wallet Status -->
      <div class="text-sm font-mono flex flex-col sm:flex-row items-center gap-2">
        <span id="wallet-status" class="bg-red-500 px-3 py-1 rounded-full text-xs font-semibold">
          Wallet Not Connected
        </span>
        <button id="connect-wallet" class="bg-blue-500 hover:bg-blue-600 transition-colors text-white px-4 py-2 rounded-lg">
          Connect Wallet
        </button>
      </div>
    </header>

    <nav class="flex flex-wrap justify-around bg-gray-200 p-4 shadow-md gap-2">
      <button id="issue-tab" class="tab-button font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105 bg-blue-500 text-white shadow-md">
        Issue Ticket
      </button>
      <button id="paid-tab" class="tab-button font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105 text-gray-800">
        Mark Paid
      </button>
      <button id="view-tab" class="tab-button font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105 text-gray-800">
        View Tickets
      </button>
      <button id="admin-tab" class="tab-button font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105 text-gray-800">
        Admin Panel
      </button>
    </nav>

    <main class="p-4 sm:p-8">
      <div id="panel-container"></div>
    </main>
    
    <!-- Floating Profile Icon and Popover -->
    <div class="fixed top-4 right-4 z-50">
        <!-- Profile Icon -->
        <button id="profile-icon" class="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-xl font-bold hover:bg-blue-600 transition-colors shadow-lg">
          ðŸ‘¤
        </button>

        <!-- Profile Popover - now always near the button -->
        <div id="profile-popover" class="hidden absolute top-14 right-0 max-w-xs w-80 bg-white rounded-lg shadow-xl p-6 border border-gray-200 transition-transform duration-300 scale-95 opacity-0">
          <h2 class="text-xl font-bold mb-4 text-gray-800">My Profile</h2>
          <div class="space-y-4 text-sm text-gray-600">
            <div class="p-3 bg-gray-50 rounded-lg border border-gray-100 shadow-sm font-mono break-all">
              <span class="font-bold text-gray-800">Address:</span>
              <p id="profile-address" class="mt-1 text-xs text-blue-500 break-all"></p>
            </div>
            <div>
              <span class="font-bold text-gray-800">Roles:</span>
              <ul id="profile-roles" class="mt-2 space-y-2">
                <li class="p-2 bg-gray-50 rounded-lg border border-gray-100 shadow-sm text-gray-400">Not connected</li>
              </ul>
            </div>
          </div>
          
          <hr class="my-4 border-gray-200" />
          
          <div>
              <h3 class="font-bold text-lg mb-2 text-gray-800">My Tickets</h3>
              <div id="profile-tickets-container" class="space-y-3 max-h-48 overflow-y-auto">
                  <p class="text-gray-400">No tickets found.</p>
              </div>
          </div>
        </div>
    </div>

    <div id="status-message" class="bg-gray-100 p-4 text-center text-gray-700 border-t border-gray-200" style="display: none;">
      <p id="status-text"></p>
    </div>
  </div>

  <script src="https://cdn.ethers.io/5.7.2/ethers.umd.min.js"></script>
  <script>
    // --- Smart Contract Configuration ---
    const CONTRACT_ADDRESS = "0xefd8e13fdccad18ac050e7602fda6faf2e2b7b5b031d6a1e3a7b0bdcf0c6754b"; // This is a placeholder address. You must update this with your deployed contract address.
    const CONTRACT_ABI = [
      "function issueTicket(bytes32 licenseHash, string calldata violationType, string calldata location, uint256 amount, uint16 points, string calldata evidenceURI, uint256 issuedAt) public returns (uint256)",
      "function markPaid(uint256 id, string calldata paymentRef) public",
      "function getTicket(uint256 id) public view returns (uint256 id, bytes32 licenseHash, string violationType, string location, uint256 timestamp, address officer, uint256 amount, uint16 points, bool paid, uint256 paidAt, string paymentRef, string metadataURI)",
      "function ticketsByLicense(bytes32 licenseHash) public view returns (uint256[] memory)",
      "function ticketsByOfficer(address officer) public view returns (uint256[] memory)",
      "function totalTickets() public view returns (uint256)",
      "function hasRole(bytes32 role, address account) public view returns (bool)",
      "function grantOfficer(address officer) public",
      "function revokeOfficer(address officer) public",
      "function grantPaymentAgent(address agent) public",
      "function revokePaymentAgent(address agent) public",
      "function pause() public",
      "function unpause() public",
    ];
    
    // --- State Variables and DOM Elements ---
    let activeTab = 'issue';
    let isWalletConnected = false;
    let userAddress = '';
    let userRoles = {
      isAdmin: false,
      isOfficer: false,
      isPaymentAgent: false,
    };
    let ethersProvider;
    let smartContract;

    const panelContainer = document.getElementById('panel-container');
    const profileAddressEl = document.getElementById('profile-address');
    const profileRolesEl = document.getElementById('profile-roles');
    const profileTicketsContainer = document.getElementById('profile-tickets-container');
    const profileIconBtn = document.getElementById('profile-icon');
    const profilePopoverEl = document.getElementById('profile-popover');
    const statusMessageEl = document.getElementById('status-message');
    const statusTextEl = document.getElementById('status-text');
    const walletStatusEl = document.getElementById('wallet-status');
    const connectWalletBtn = document.getElementById('connect-wallet');
    const tabButtons = document.querySelectorAll('.tab-button');
    let isPaused = false; // Add this variable to track contract state
    
    // --- Helper Functions ---
    const setStatusMessage = (message) => {
      statusMessageEl.style.display = 'block';
      statusTextEl.textContent = message;
      setTimeout(() => {
        statusMessageEl.style.display = 'none';
      }, 5000);
    };

    const updateWalletStatus = () => {
      if (isWalletConnected) {
        walletStatusEl.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
        walletStatusEl.classList.remove('bg-red-500');
        walletStatusEl.classList.add('bg-green-500');
        connectWalletBtn.style.display = 'none';
      } else {
        walletStatusEl.textContent = 'Wallet Not Connected';
        walletStatusEl.classList.remove('bg-green-500');
        walletStatusEl.classList.add('bg-red-500');
        connectWalletBtn.style.display = 'inline-block';
      }
    };
    
    const updateProfilePopover = async () => {
      if (isWalletConnected) {
        profileAddressEl.textContent = userAddress;
        
        // Fetch roles from the smart contract
        try {
          const ADMIN_ROLE = "0x0000000000000000000000000000000000000000000000000000000000000000";
          const OFFICER_ROLE = "0x4b7762696666696365725f726f6c650000000000000000000000000000000000";
          const PAYMENT_ROLE = "0x5041594d454e545f524f4c450000000000000000000000000000000000000000";
          userRoles.isAdmin = await smartContract.hasRole(ADMIN_ROLE, userAddress);
          userRoles.isOfficer = await smartContract.hasRole(OFFICER_ROLE, userAddress);
          userRoles.isPaymentAgent = await smartContract.hasRole(PAYMENT_ROLE, userAddress);
        } catch (error) {
          console.error("Failed to fetch roles:", error);
          setStatusMessage("Failed to load user roles from contract.");
        }
        
        profileRolesEl.innerHTML = '';
        const roles = [];
        if (userRoles.isAdmin) roles.push(`<span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full font-bold text-xs">Admin</span>`);
        if (userRoles.isOfficer) roles.push(`<span class="bg-blue-200 text-blue-800 px-2 py-1 rounded-full font-bold text-xs">Officer</span>`);
        if (userRoles.isPaymentAgent) roles.push(`<span class="bg-green-200 text-green-800 px-2 py-1 rounded-full font-bold text-xs">Payment Agent</span>`);
        
        if (roles.length > 0) {
          roles.forEach(roleHtml => {
            const li = document.createElement('li');
            li.className = "p-2 bg-gray-50 rounded-lg border border-gray-100 shadow-sm";
            li.innerHTML = roleHtml;
            profileRolesEl.appendChild(li);
          });
        } else {
          profileRolesEl.innerHTML = `<li class="p-2 bg-gray-50 rounded-lg border border-gray-100 shadow-sm text-gray-400">No roles found</li>`;
        }

        // Fetch tickets issued by the user (if an officer)
        profileTicketsContainer.innerHTML = '<p class="text-gray-400">No tickets found.</p>'; // Reset
        if (userRoles.isOfficer) {
            try {
                const ticketIds = await smartContract.ticketsByOfficer(userAddress);
                profileTicketsContainer.innerHTML = '';
                if (ticketIds.length > 0) {
                    for (const id of ticketIds) {
                        const ticket = await smartContract.getTicket(id);
                        const ticketEl = document.createElement('div');
                        ticketEl.className = "p-3 border border-gray-200 rounded-lg shadow-sm bg-white text-xs";
                        ticketEl.innerHTML = `
                            <p><strong>ID:</strong> ${ticket.id}</p>
                            <p><strong>Violation:</strong> ${ticket.violationType}</p>
                            <p><strong>Status:</strong> <span class="font-bold ${ticket.paid ? 'text-green-600' : 'text-red-600'}">${ticket.paid ? 'Paid' : 'Unpaid'}</span></p>
                        `;
                        profileTicketsContainer.appendChild(ticketEl);
                    }
                } else {
                    profileTicketsContainer.innerHTML = '<p class="text-gray-400">No tickets issued.</p>';
                }
            } catch (error) {
                console.error("Failed to fetch user tickets:", error);
                profileTicketsContainer.innerHTML = '<p class="text-red-500">Error fetching tickets.</p>';
            }
        }
        
      } else {
        profileAddressEl.textContent = 'Not Connected';
        profileRolesEl.innerHTML = `<li class="p-2 bg-gray-50 rounded-lg border border-gray-100 shadow-sm text-gray-400">Not connected</li>`;
        profileTicketsContainer.innerHTML = '<p class="text-gray-400">Connect wallet to view tickets.</p>';
      }
    };
    
    // --- Event Handlers ---
    const connectWallet = async () => {
        // Step 1: Check if a Web3-compatible wallet (like MetaMask) is available in the browser.
        if (typeof window.ethereum !== 'undefined') {
            setStatusMessage('Web3 wallet detected. Requesting connection...');
            try {
                // Step 2: Request access to the user's accounts.
                // This is the specific line that triggers the wallet pop-up.
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                // Step 3: Create an Ethers.js provider and signer to interact with the wallet and blockchain.
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Step 4: Initialize the contract instance with the signer to enable transactions.
                ethersProvider = provider;
                smartContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                isWalletConnected = true;
                updateWalletStatus();
                await updateProfilePopover();
                setStatusMessage('Wallet connected! Roles loaded.');
                renderPanel();

            } catch (error) {
                // Handle potential errors from the wallet, such as the user rejecting the connection.
                console.error("Failed to connect wallet:", error);
                setStatusMessage('Failed to connect wallet. Please ensure you have a wallet and approve the connection.');
            }
        } else {
            // Step 1 (Alternative): If no wallet is found, show a message to the user.
            setStatusMessage('No web3 wallet detected. Please install a browser extension like MetaMask.');
        }
    };
    
    const handleIssueSubmit = async (e) => {
      e.preventDefault();
      setStatusMessage('Issuing ticket...');
      const form = e.target;
      try {
        const tx = await smartContract.issueTicket(
          form['issue-license'].value,
          form['issue-violation'].value,
          form['issue-location'].value,
          form['issue-amount'].value,
          form['issue-points'].value,
          form['issue-evidence'].value,
          Math.floor(Date.now() / 1000)
        );
        await tx.wait();
        setStatusMessage('Ticket issued successfully!');
        e.target.reset();
        await updateProfilePopover(); // Refresh profile to show the new ticket
      } catch (error) {
        console.error("Failed to issue ticket:", error);
        setStatusMessage('Failed to issue ticket. Check console for details.');
      }
    };

    // Remaining functions are left as-is for brevity but would be modified
    // to use the `smartContract` object for real interactions.
    const handlePaidSubmit = async (e) => {
      e.preventDefault();
      setStatusMessage('Marking ticket as paid...');
      try {
        const tx = await smartContract.markPaid(
          document.getElementById('paid-id').value,
          document.getElementById('paid-ref').value
        );
        await tx.wait();
        setStatusMessage('Ticket marked as paid successfully!');
        e.target.reset();
      } catch (error) {
        console.error("Failed to mark paid:", error);
        setStatusMessage('Failed to mark paid. Check console for details.');
      }
    };

    const handleViewSubmit = async (e) => {
      e.preventDefault();
      setStatusMessage('Searching for tickets...');
      const id = document.getElementById('view-id').value;
      const licenseHash = document.getElementById('view-license').value;
      const officerAddress = document.getElementById('view-officer').value;

      const resultsContainer = document.getElementById('view-results');
      resultsContainer.innerHTML = '';
      try {
        let ticketIds = [];
        if (id) {
            const ticket = await smartContract.getTicket(id);
            if (ticket.id.toString() === id) { // Verify the returned ticket ID matches
                ticketIds.push(id);
            }
        } else if (licenseHash) {
            ticketIds = await smartContract.ticketsByLicense(licenseHash);
        } else if (officerAddress) {
            ticketIds = await smartContract.ticketsByOfficer(officerAddress);
        }
        
        if (ticketIds.length > 0) {
            for (const ticketId of ticketIds) {
                const ticket = await smartContract.getTicket(ticketId);
                const ticketEl = document.createElement('div');
                ticketEl.className = "p-4 border border-gray-200 rounded-lg shadow-sm bg-white";
                ticketEl.innerHTML = `
                  <p><strong>ID:</strong> ${ticket.id}</p>
                  <p><strong>Status:</strong> <span class="font-bold ${ticket.paid ? 'text-green-600' : 'text-red-600'}">${ticket.paid ? 'Paid' : 'Unpaid'}</span></p>
                  <p><strong>License Hash:</strong> ${ticket.licenseHash}</p>
                  <p><strong>Violation:</strong> ${ticket.violationType}</p>
                  <p><strong>Officer:</strong> ${ticket.officer}</p>
                  <p><strong>Amount:</strong> $${ethers.utils.formatUnits(ticket.amount, 0)}</p>
                `;
                resultsContainer.appendChild(ticketEl);
            }
        } else {
            resultsContainer.innerHTML = '<p class="text-gray-500">No tickets found.</p>';
        }
        setStatusMessage('Search complete.');
      } catch (error) {
        console.error("Failed to search:", error);
        setStatusMessage('Failed to search tickets. Check console for details.');
      }
    };

    const handleAdminAction = async (action) => {
      setStatusMessage(`Executing admin action: ${action}...`);
      try {
        const signer = smartContract.signer;
        let tx;
        if (action === 'pause') {
            tx = await signer.pause();
        } else if (action === 'unpause') {
            tx = await signer.unpause();
        } else {
            const targetAddress = document.getElementById('admin-target').value;
            if (!targetAddress) {
              setStatusMessage("Target address is required.");
              return;
            }
            if (action === 'grant-officer') {
                tx = await smartContract.grantOfficer(targetAddress);
            } else if (action === 'revoke-officer') {
                tx = await smartContract.revokeOfficer(targetAddress);
            } else if (action === 'grant-payment') {
                tx = await smartContract.grantPaymentAgent(targetAddress);
            } else if (action === 'revoke-payment') {
                tx = await smartContract.revokePaymentAgent(targetAddress);
            }
        }
        if (tx) {
            await tx.wait();
            setStatusMessage(`Admin action "${action}" successful!`);
            await updateProfilePopover(); // Refresh roles after admin action
        }
      } catch (error) {
        console.error("Failed to perform admin action:", error);
        setStatusMessage('Failed to perform admin action. Check console for details.');
      }
    };
    
    // --- UI Logic & Listeners ---
    const toggleProfilePopover = () => {
      const isHidden = profilePopoverEl.classList.contains('hidden');
      if (isHidden) {
        profilePopoverEl.classList.remove('hidden', 'scale-95', 'opacity-0');
        profilePopoverEl.classList.add('scale-100', 'opacity-100');
      } else {
        profilePopoverEl.classList.remove('scale-100', 'opacity-100');
        profilePopoverEl.classList.add('scale-95', 'opacity-0');
        setTimeout(() => profilePopoverEl.classList.add('hidden'), 300);
      }
    };
    
    const setActiveTab = (tab) => {
      activeTab = tab;
      tabButtons.forEach(button => {
        button.classList.remove('bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-yellow-500', 'text-white', 'shadow-md');
        button.classList.add('text-gray-800');
        if (button.id.startsWith(tab)) {
          let color = '';
          switch (tab) {
            case 'issue':
              color = 'blue';
              break;
            case 'paid':
              color = 'green';
              break;
            case 'view':
              color = 'purple';
              break;
            case 'admin':
              color = 'yellow';
              break;
          }
          button.classList.add(`bg-${color}-500`, 'text-white', 'shadow-md');
        }
      });
      renderPanel();
    };

    const attachPanelListeners = () => {
      if (activeTab === 'issue') {
        const form = document.getElementById('issue-form');
        if (form) form.addEventListener('submit', handleIssueSubmit);
      } else if (activeTab === 'paid') {
        const form = document.getElementById('paid-form');
        if (form) form.addEventListener('submit', handlePaidSubmit);
      } else if (activeTab === 'view') {
        const form = document.getElementById('view-form');
        if (form) form.addEventListener('submit', handleViewSubmit);
      } else if (activeTab === 'admin') {
        document.getElementById('grant-officer')?.addEventListener('click', () => handleAdminAction('grant-officer'));
        document.getElementById('revoke-officer')?.addEventListener('click', () => handleAdminAction('revoke-officer'));
        document.getElementById('grant-payment')?.addEventListener('click', () => handleAdminAction('grant-payment'));
        document.getElementById('revoke-payment')?.addEventListener('click', () => handleAdminAction('revoke-payment'));
        document.getElementById('pause-unpause')?.addEventListener('click', () => handleAdminAction(isPaused ? 'unpause' : 'pause'));
      }
    };
    
    const renderPanel = () => {
      let panelContent = '';
      switch (activeTab) {
        case 'issue':
          panelContent = `
            <div class="p-8 bg-gray-50 rounded-lg shadow-inner">
              <h2 class="text-2xl font-bold mb-4 text-gray-800">Issue New Ticket</h2>
              ${userRoles.isOfficer ? `
              <form id="issue-form" class="space-y-4">
                <input type="text" id="issue-license" placeholder="License Hash (bytes32)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                <input type="text" id="issue-violation" placeholder="Violation Type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                <input type="text" id="issue-location" placeholder="Location" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <input type="number" id="issue-amount" placeholder="Amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                <input type="number" id="issue-points" placeholder="Points" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required />
                <input type="text" id="issue-evidence" placeholder="Evidence URI" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                  Issue Ticket
                </button>
              </form>
              ` : `
              <p class="text-red-500 font-medium">You must have the OFFICER_ROLE to issue a ticket.</p>
              `}
            </div>
          `;
          break;
        case 'paid':
          panelContent = `
            <div class="p-8 bg-gray-50 rounded-lg shadow-inner">
              <h2 class="text-2xl font-bold mb-4 text-gray-800">Mark Ticket as Paid</h2>
              ${userRoles.isPaymentAgent ? `
              <form id="paid-form" class="space-y-4">
                <input type="number" id="paid-id" placeholder="Ticket ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required />
                <input type="text" id="paid-ref" placeholder="Payment Reference" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required />
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow-lg">
                  Mark as Paid
                </button>
              </form>
              ` : `
              <p class="text-red-500 font-medium">You must have the PAYMENT_ROLE to mark a ticket as paid.</p>
              `}
            </div>
          `;
          break;
        case 'view':
          panelContent = `
            <div class="p-8 bg-gray-50 rounded-lg shadow-inner">
              <h2 class="text-2xl font-bold mb-4 text-gray-800">View Tickets</h2>
              <form id="view-form" class="space-y-4 mb-8">
                <input type="text" id="view-id" placeholder="Search by Ticket ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                <input type="text" id="view-license" placeholder="Search by License Hash" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                <input type="text" id="view-officer" placeholder="Search by Officer Address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" />
                <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors shadow-lg">
                  Search
                </button>
              </form>
              <h3 class="text-xl font-bold mb-2 text-gray-800">Results</h3>
              <div id="view-results" class="space-y-4"></div>
            </div>
          `;
          break;
        case 'admin':
          panelContent = `
            <div class="p-8 bg-gray-50 rounded-lg shadow-inner">
              <h2 class="text-2xl font-bold mb-4 text-gray-800">Admin Panel</h2>
              ${userRoles.isAdmin ? `
              <div class="space-y-6">
                <div class="flex flex-col space-y-4">
                  <input type="text" id="admin-target" placeholder="Target Address" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" />
                  <div class="grid grid-cols-2 gap-4">
                    <button id="grant-officer" class="bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-700 transition-colors shadow-lg">Grant Officer</button>
                    <button id="revoke-officer" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-colors shadow-lg">Revoke Officer</button>
                    <button id="grant-payment" class="bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-yellow-700 transition-colors shadow-lg">Grant Payment Agent</button>
                    <button id="revoke-payment" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-colors shadow-lg">Revoke Payment Agent</button>
                  </div>
                </div>
                <hr class="border-gray-300" />
                <div class="flex justify-between items-center">
                  <span class="font-medium">Contract Status: <span id="contract-status">${isPaused ? 'Paused' : 'Active'}</span></span>
                  <button id="pause-unpause" class="font-bold py-3 px-6 rounded-lg transition-colors shadow-lg ${isPaused ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white">${isPaused ? 'Unpause' : 'Pause'}</button>
                </div>
              </div>
              ` : `
              <p class="text-red-500 font-medium">You must have the DEFAULT_ADMIN_ROLE to access this panel.</p>
              `}
            </div>
          `;
          break;
      }
      panelContainer.innerHTML = panelContent;
      attachPanelListeners();
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      connectWalletBtn.addEventListener('click', connectWallet);
      document.getElementById('issue-tab').addEventListener('click', () => setActiveTab('issue'));
      document.getElementById('paid-tab').addEventListener('click', () => setActiveTab('paid'));
      document.getElementById('view-tab').addEventListener('click', () => setActiveTab('view'));
      document.getElementById('admin-tab').addEventListener('click', () => setActiveTab('admin'));
      profileIconBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleProfilePopover();
      });

      document.addEventListener('click', (e) => {
        if (!profilePopoverEl.contains(e.target) && !profileIconBtn.contains(e.target)) {
          profilePopoverEl.classList.remove('scale-100', 'opacity-100');
          profilePopoverEl.classList.add('scale-95', 'opacity-0');
          setTimeout(() => profilePopoverEl.classList.add('hidden'), 300);
        }
      });
      
      updateWalletStatus();
      renderPanel();
    });
  </script>
</body>
</html>

